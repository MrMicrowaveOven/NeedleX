<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Needle Exchange Map</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  </head>
  <body>
    <div class="" id="map">

    </div>
    <script type="text/javascript">
    function makeMap(lat, lng) {
      lat = lat || 37.779966
      lng = lng || -122.35
      var mapOptions = {
        center: new google.maps.LatLng(lat, lng),
        zoom: 12,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      }
      var map = new google.maps.Map(document.getElementById("map"), mapOptions);


      geocoder = new google.maps.Geocoder();
      $.get("/locations", function(data) {
        console.log(data);
        data.forEach(function(location) {
          // console.log(location.address);
          geocoder.geocode( { 'address': location.address}, function(results, status) {
            if (status == 'OK') {
              // map.setCenter(results[0].geometry.location);
              // var image = {
              //   url: "https://maxcdn.icons8.com/Share/icon/Healthcare//syringe1600.png",
              //   size: new google.maps.Size(20, 20),
                // origin: new google.maps.Point(0, 0),
                // anchor: new google.maps.Point(0, 32)
              // }
              var marker = new google.maps.Marker({
                map: map,
                position: results[0].geometry.location,
                // icon: image
              });

              var contentString = (location.name || "") + "<br>" + location.address + "<br>" + location.description
                + "<br>" + location.link + "<br>" + (location.phoneNumber || "")

              var infowindow = new google.maps.InfoWindow({
                content: contentString
              });
              marker.addListener('click', function() {
                infowindow.open(map, marker);
              });
              // google.maps.event.addListener(map, 'click', infowindow.close());
              // marker.addListener('blur', function() {
              //   infowindow.close();
              // });
            } else {
              alert('Geocode was not successful for the following reason: ' + status);
            }
          });
        })


      });

      // var marker = new google.maps.Marker({
      //     position: {lat: lat, lng: lng},
      //     map: map
      // });
    }

    // Include Google Maps script with env variables
    var GOOGLE_API_KEY = $.get("/welcome/1", function(googleApiKey) {
      var JSLink = "https://maps.googleapis.com/maps/api/js?key=" + googleApiKey.GoogleAPIKey + "&callback=makeMap";
      var JSElement = document.createElement('script');
      JSElement.src = JSLink;
      document.getElementsByTagName('head')[0].appendChild(JSElement);
    })
    </script>
    <style media="screen">
    #map {
      height: 100%;
    }
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </body>
</html>
