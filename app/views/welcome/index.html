<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Needle Exchange Map</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  </head>
  <body>
    <div class="" id="map">

    </div>
    <script type="text/javascript">
    DAYSOFWEEK = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    dayButtons = [];
    markers = [];
    infoWindows = [];

    function makeMap(lat, lng) {
      lat = lat || 37.765
      lng = lng || -122.42
      var mapOptions = {
        center: new google.maps.LatLng(lat, lng),
        zoom: 13,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      }
      var map = new google.maps.Map(document.getElementById("map"), mapOptions);

// Add day filter buttons at top of screen
      dayOfWeekInt = new Date().getDay();
      var selected;
      ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"].forEach(function(day, dayIndex) {
        var dayDiv = document.createElement('div');
        selected = dayIndex == dayOfWeekInt
        var dayControl = new DayButton(dayDiv, map, day, selected);

        dayDiv.index = dayIndex;
        map.controls[google.maps.ControlPosition.TOP_CENTER].push(dayDiv);
      })
      addMarkers(map);
    }

    function hideAllMarkers() {
      markers.forEach(function(marker) {
        marker.setVisible(false);
      })
    }

    function showApplicableMarkers() {
      markers.forEach(function(marker, locationIndex) {
        for (var i = 0; i < 7; i++) {
          if (dayButtons[i].style.backgroundColor == "darkgray" && infoWindows[locationIndex][i]) {
            marker.setVisible(true)
          }
        }
      })
    }
    function addMarkers(map) {
      $.get("/locations", function(data) {
        console.log(data);
        data.forEach(function(location, locationIndex) {
          // map.setCenter(results[0].geometry.location);
          var image = {
            url: "https://68.media.tumblr.com/08815ef78ff0dc07bf671d7dc25f2428/tumblr_ovgx0j0zXk1v497yzo1_75sq.png",
            // size: new google.maps.Size(64, 64),
            // origin: new google.maps.Point(0, 0),
            // anchor: new google.maps.Point(128, 128)
          }
          var marker = new google.maps.Marker({
            map: map,
            position: {lat: parseFloat(location.lat), lng: parseFloat(location.lng)},
            icon: image
          });

          if(location.phone_number) {
            var firstThreeDigits = location.phone_number.slice(0,3)
            var secondThreeDigits = location.phone_number.slice(3,6)
            var lastFourDigits = location.phone_number.slice(6,10)
            var phone_number = "(" + firstThreeDigits + ") " + secondThreeDigits + "-" + lastFourDigits;
          } else {
            var phone_number = "";
          }

          var contentString = "<h3>" + location.name + "</h3>" + location.address.split(",")[0] + "<br>";

          secondHalfOfAddress = location.address.split(",")
          secondHalfOfAddress.shift()
          contentString += secondHalfOfAddress.join() + "<br>";
          location.description ? contentString += location.description + "<br>" : 0;
          location.link ? contentString += location.link + "<br>" : 0;
          contentString += phone_number + "<br><br>";
          contentString += "<strong>Hours:</strong><br>"
          infoWindows.push({})

          location.availabilities.forEach(function(availability) {
            var opening = new Date(availability.opening)
            var openingHour = opening.getHours()
            var openingMinutes = (opening.getMinutes() + "").length < 2 ? "0" + opening.getMinutes() : opening.getMinutes();
            var openingTimeString = openingHour + ":" + openingMinutes

            var closing = new Date(availability.closing)
            var closingHour = closing.getHours()
            var closingMinutes = (closing.getMinutes() + "").length < 2 ? "0" + closing.getMinutes() : closing.getMinutes();
            var closingTimeString = closingHour + ":" + closingMinutes

            contentString += DAYSOFWEEK[availability.day_of_week] + ": " + openingTimeString + "-" + closingTimeString + "<br>";

            infoWindows[locationIndex][availability.day_of_week] = true;
          })

          var infowindow = new google.maps.InfoWindow({
            content: contentString
          });
          marker.addListener('click', function() {
            infowindow.open(map, marker);
          });
          // google.maps.event.addListener(map, 'click', infowindow.close());
          map.addListener('click', function() {
            infowindow.close();
          });
          markers.push(marker)
        });
        hideAllMarkers()
        showApplicableMarkers()
      })
    }

      // Include Google Maps script with env variables
      var GOOGLE_API_KEY = $.get("/welcome/1", function(googleApiKey) {
        var JSLink = "https://maps.googleapis.com/maps/api/js?key=" + googleApiKey.GoogleAPIKey + "&callback=makeMap";
        var JSElement = document.createElement('script');
        JSElement.src = JSLink;
        document.getElementsByTagName('head')[0].appendChild(JSElement);
      })

// DayButton Constructor
      function DayButton(controlDiv, map, day, selected) {
        // Set CSS for the control border.
        var controlUI = document.createElement('div');
        controlUI.style.backgroundColor = selected ? "darkgray" : '#fff';
        controlUI.style.border = '2px solid #fff';
        controlUI.style.borderRadius = '3px';
        controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
        controlUI.style.cursor = 'pointer';
        controlUI.style.marginBottom = '22px';
        controlUI.style.textAlign = 'center';
        // controlUI.title = 'Click to show c';
        controlDiv.appendChild(controlUI);

        // Set CSS for the control interior.
        var controlText = document.createElement('div');
        controlText.style.color = 'rgb(25,25,25)';
        controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
        controlText.style.fontSize = '16px';
        controlText.style.lineHeight = '38px';
        controlText.style.paddingLeft = '5px';
        controlText.style.paddingRight = '5px';
        controlText.innerHTML = day;
        controlUI.appendChild(controlText);

        // Setup the click event listeners: simply set the map to Chicago.
        controlUI.addEventListener('click', function() {
          var currentColor = controlUI.style.backgroundColor
          controlUI.style.backgroundColor = currentColor == "rgb(255, 255, 255)" ? "darkgray" : "rgb(255, 255, 255)";
          hideAllMarkers()
          showApplicableMarkers()
        });
        dayButtons.push(controlUI)
      }
    </script>
    <style media="screen">
    #map {
      height: 100%;
    }
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </body>
</html>
